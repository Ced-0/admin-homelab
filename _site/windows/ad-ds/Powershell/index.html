<h1 id="-powershell--administration-active-directory">⚡ PowerShell – Administration Active Directory</h1>

<h2 id="1-installation-ad-ds">1. Installation AD DS</h2>
<ul>
  <li>Installer le rôle AD DS</li>
</ul>

<pre><code class="language-powershell">Install-WindowsFeature AD-Domain-Services -IncludeManagementTools
</code></pre>
<ul>
  <li>Vérifier l’installation</li>
</ul>

<pre><code class="language-powershell">Get-WindowsFeature AD-Domain-Services
</code></pre>

<h2 id="2-promotion-en-contrôleur-de-domaine">2. Promotion en contrôleur de domaine</h2>
<ul>
  <li>Promouvoir un serveur en nouveau domaine</li>
</ul>

<pre><code class="language-powershell">Install-ADDSForest `
    -DomainName "Homelab.local" `
    -DomainNetbiosName "HOMELAB" `
    -SafeModeAdministratorPassword (Read-Host -AsSecureString "Mot de passe DSRM") `
    -InstallDns
</code></pre>
<ul>
  <li>Promouvoir un serveur dans un domaine existant</li>
</ul>

<pre><code class="language-powershell">Install-ADDSDomainController `
    -DomainName "Homelab.local" `
    -Credential (Get-Credential) `
    -InstallDns
</code></pre>
<ul>
  <li>Vérifier l’état du contrôleur de domaine</li>
</ul>

<pre><code class="language-powershell">Get-ADDomainController -Filter *
</code></pre>

<h2 id="3-création-des-ou">3. Création des OU</h2>
<ul>
  <li>Créer une OU</li>
</ul>

<pre><code class="language-powershell">New-ADOrganizationalUnit -Name "Mon entreprise" -ProtectedFromAccidentalDeletion $true
</code></pre>
<ul>
  <li>Créer plusieurs OU</li>
</ul>

<pre><code class="language-powershell">$OUList = "Groupes","Ordinateurs","Utilisateurs"

foreach ($ou in $OUList) {
    New-ADOrganizationalUnit -Name $ou -Path "OU=Mon entreprise,DC=homelab,DC=local"
}
</code></pre>
<ul>
  <li>Lister les OU</li>
</ul>

<pre><code class="language-powershell">Get-ADOrganizationalUnit -Filter * | Select Name, DistinguishedName
</code></pre>

<h2 id="4-création-des-utilisateurs">4. Création des utilisateurs</h2>
<ul>
  <li>Créer un utilisateur</li>
</ul>

<pre><code class="language-powershell">New-ADUser `
    -Name "Christian Hef" `
    -SamAccountName Chef `
    -UserPrincipalName chef@homelab.local `
    -Path "OU=Utilisateurs,OU=Mon entreprise,DC=homelab,DC=local" `
    -AccountPassword (Read-Host -AsSecureString "Mot de passe") `
    -ChangePasswordAtLogon $true `
    -Enabled $true
</code></pre>
<ul>
  <li>Définir un dossier personnel</li>
</ul>

<pre><code class="language-powershell">Set-ADUser utilisateur1 -HomeDirectory "\\SERVEUR\Utilisateurs\utilisateur1" -HomeDrive "H:"
</code></pre>
<ul>
  <li>Désactiver / activer un compte</li>
</ul>

<pre><code class="language-powershell">Disable-ADAccount -Identity utilisateur1
Enable-ADAccount -Identity utilisateur1
</code></pre>
<ul>
  <li>Réinitialiser un mot de passe</li>
</ul>

<pre><code class="language-powershell">Set-ADAccountPassword utilisateur1 -Reset -NewPassword (Read-Host -AsSecureString "Nouveau mot de passe")
</code></pre>

<h2 id="5-création-des-groupes-globaux">5. Création des groupes globaux</h2>
<ul>
  <li>Créer un groupe global</li>
</ul>

<pre><code class="language-powershell">New-ADGroup -Name "GG_Direction" -GroupScope Global -Path "OU=Services,OU=Groupes,OU=Mon entreprise,DC=homelab,DC=local"
</code></pre>
<ul>
  <li>Créer plusieurs groupe globaux</li>
</ul>

<pre><code class="language-powershell">$Groups = "GG_Direction","GG_Comptabilité","GG_Sécrétariat","GG_Production","GG_Support"

foreach ($g in $Groups) {
    New-ADGroup -Name $g -GroupScope Global -Path "OU=Services,OU=Groupes,OU=Mon entreprise,DC=homelab,DC=local"
}
</code></pre>
<ul>
  <li>Ajouter un utilisateur à un groupe</li>
</ul>

<pre><code class="language-powershell">Add-ADGroupMember -Identity "GG_Direction" -Members utilisateur1
</code></pre>
<ul>
  <li>Ajouter plusieurs utilisateurs à un groupe</li>
</ul>

<pre><code class="language-powershell">Add-ADGroupMember -Identity "GG_Production" -Members user1,user2,user3
</code></pre>

<h2 id="5-création-des-groupes-de-domaine-local">5. Création des groupes de domaine local</h2>
<ul>
  <li>Créer un groupe de domaine local</li>
</ul>

<pre><code class="language-powershell">New-ADGroup -Name "DL_DATA_RO" -GroupScope DomainLocal -Path "OU=Partages,OU=Groupes,OU=Mon entreprise,DC=homelab,DC=local"
</code></pre>
<ul>
  <li>Créer plusieurs groupe de domaine local</li>
</ul>

<pre><code class="language-powershell">$groupNames = @(
    "DL_DATA_RO", "DL_DATA_RW",
    "DL_SERVICES_RO", "DL_SERVICES_RW",
    "DL_DIRECTION_RO", "DL_DIRECTION_RW",
    "DL_COMPTABILITE_RO", "DL_COMPTABILITE_RW",
    "DL_SECRETARIAT_RO", "DL_SECRETARIAT_RW",
    "DL_SUPPORT_RO", "DL_SUPPORT_RW",
    "DL_PUBLIC_RO", "DL_PUBLIC_RW",
    "DL_INFORMATIQUE_RO", "DL_INFORMATIQUE_RW"
)

foreach ($group in $groupNames) {
        New-ADGroup -Name $group -GroupScope DomainLocal -Path "OU=Partages,OU=Groupes,OU=Mon entreprise,DC=homelab,DC=local"
}
</code></pre>
<ul>
  <li>Ajouter un groupe global à un groupe de domaine local</li>
</ul>

<pre><code class="language-powershell">Add-ADGroupMember -Identity "DL_DATA_RO" -Members "GG_Direction"
</code></pre>

<ul>
  <li>Ajouter plusieurs groupe globaux à un groupe de domaine local</li>
</ul>

<pre><code class="language-powershell">Add-ADGroupMember -Identity "DL_DATA_RO" -Members "GG_Direction","GG_Comptabilite","GG_Secretariat"
</code></pre>

<h2 id="6-création-de-gpo-verouillage-écran">6. Création de GPO verouillage écran</h2>

<ul>
  <li>Créer la GPO</li>
</ul>

<pre><code class="language-powershell">New-GPO -Name "Verrouillage_Automatique" -Comment "Verrouillage automatique écran de veille"
</code></pre>
<ul>
  <li>Activer l’écran de veille</li>
</ul>

<pre><code class="language-powershell">Set-GPRegistryValue -Name $GpoName -Key "HKCU\Software\Policies\Microsoft\Windows\Control Panel\Desktop" -ValueName "ScreenSaveActive" -Type String -Value "1"
</code></pre>
<ul>
  <li>Temps d’attente pour le verrouillage (600 secondes = 10 minutes)</li>
</ul>

<pre><code class="language-powershell">Set-GPRegistryValue -Name "Verrouillage_Automatique" -Key "HKCU\Software\Policies\Microsoft\Windows\Control Panel\Desktop" -ValueName "ScreenSaveTimeOut" -Type String -Value "600"
</code></pre>
<ul>
  <li>Empêcher la modification de l’écran de veille</li>
</ul>

<pre><code class="language-powershell">Set-GPRegistryValue -Name "Verrouillage_Automatique" -Key "HKCU\Software\Policies\Microsoft\Windows\Control Panel\Desktop" -ValueName "ScreenSaverIsSecure" -Type String -Value "1"
</code></pre>
<ul>
  <li>Lier la GPO à l’OU avec l’option Appliqué (Enforced)</li>
</ul>

<pre><code class="language-powershell">New-GPLink -Name "Verrouillage_Automatique" -Target "OU=Utilisateurs,OU=Mon Entreprise,DC=Homelab,DC=local" -Enforced "Yes"
</code></pre>

<h2 id="7-automatisation">7. Automatisation</h2>
<ul>
  <li>Script simple de création d’un utilisateur</li>
</ul>

<pre><code class="language-powershell"># Demande des informations
$Prenom = Read-Host "Prénom"
$Nom = Read-Host "Nom"
$Password = Read-Host -AsSecureString "Mot de passe"

# Génère le SamAccountName (initiale + nom de famille, en minuscules)
$Sam = ($Prenom.Substring(0,1) + $Nom).ToLower()

# Création du compte AD
New-ADUser `
    -GivenName $Prenom `
    -Surname $Nom `
    -Name "$Prenom $Nom" `
    -SamAccountName $Sam `
    -UserPrincipalName ($Sam + "@homelab.local") `
    -AccountPassword $Password `
    -Path "OU=Utilisateurs,OU=Mon entreprise,DC=homelab,DC=local" `
    -ChangePasswordAtLogon $true `
    -Enabled $true
</code></pre>

<hr />
